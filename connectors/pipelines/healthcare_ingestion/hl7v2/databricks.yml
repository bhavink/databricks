# HL7v2 Pipeline - Databricks Asset Bundle
# =========================================
#
# Run independently:
#   cd pipelines/healthcare_ingestion/hl7v2
#   databricks bundle deploy -t dev
#   databricks bundle run hl7v2_pipeline -t dev

bundle:
  name: healthcare_hl7v2

variables:
  catalog:
    description: Unity Catalog name
    default: main
  schema:
    description: Schema for HL7v2 tables
    default: healthcare
  volume:
    description: Volume for raw HL7v2 files
    default: raw_data

resources:
  pipelines:
    hl7v2_pipeline:
      name: "HL7v2 Ingestion - ${bundle.target}"
      catalog: ${var.catalog}
      schema: ${var.schema}
      serverless: true
      photon: true
      channel: CURRENT
      
      libraries:
        - file:
            path: ./transformations/bronze_hl7v2.py
      
      configuration:
        # Pipeline Protection (GDPR - prevent accidental reset undoing deletions)
        pipelines.reset.allowed: "false"
        # Source
        healthcare.storage_path: "/Volumes/${var.catalog}/${var.schema}/${var.volume}/hl7v2"
        healthcare.file_pattern: "*.hl7"
        healthcare.max_files_per_trigger: "1000"
        healthcare.max_bytes_per_trigger: "10g"
        # Quality
        healthcare.quality.error_handling: "quarantine"
        healthcare.quality.enable_expectations: "true"
        healthcare.quality.quarantine_invalid_records: "true"
        # Clustering
        healthcare.clustering.enabled: "true"
        healthcare.clustering.raw.columns: "message_type,_ingestion_timestamp"
        healthcare.clustering.adt.columns: "patient_id,message_datetime"
        healthcare.clustering.orm.columns: "patient_id,order_datetime"
        healthcare.clustering.oru.columns: "patient_id,message_datetime"
        healthcare.clustering.oru_observations.columns: "patient_id,observation_datetime"
        healthcare.clustering.siu.columns: "patient_id,appointment_start_datetime"
        healthcare.clustering.vxu.columns: "patient_id,message_datetime"
        healthcare.clustering.vxu_vaccinations.columns: "patient_id,administration_datetime"
        healthcare.clustering.quarantine.columns: "message_type,_ingestion_timestamp"
        # Features
        healthcare.features.parse_composite_fields: "true"
        healthcare.features.flatten_observations: "true"
        healthcare.features.flatten_vaccinations: "true"

targets:
  dev:
    mode: development
    default: true
    variables:
      schema: healthcare_dev
    resources:
      pipelines:
        hl7v2_pipeline:
          development: true
          continuous: false

  prod:
    mode: production
    variables:
      schema: healthcare_prod
    resources:
      pipelines:
        hl7v2_pipeline:
          development: false
          continuous: true
