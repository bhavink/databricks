################################################################################
# DATABRICKS GCE COMPUTE MIGRATION - FIREWALL UPDATE POLICY
################################################################################
#
# PURPOSE:
# This policy allows Databricks to update firewall rules in customer-managed VPCs
# during the migration from GKE-based to GCE-based classic compute clusters.
#
# WHEN TO USE:
# - During the GCE compute migration announced by Databricks
# - When Databricks needs to create/update firewall rules for delegate-sa
# - One-time migration activity (not ongoing operational policy)
#
# WHAT THIS IS:
# This is an IAM conditional policy or org policy constraint - NOT a VPC Service
# Controls policy. It grants temporary permission for Databricks to manage
# firewall rules in your customer-managed VPC.
#
# DOCUMENTATION:
# - Migration Announcement: https://docs.databricks.com/gcp/en/admin/cloud-configurations/gcp/gce-update
# - CMV Requirements: https://docs.databricks.com/gcp/en/admin/cloud-configurations/gcp/gce-update#updates-needed-for-customer-managed-vpcs
# - Regional Resources: https://docs.databricks.com/gcp/en/resources/ip-domain-region
#
# IMPORTANT NOTES:
# - This is a ONE-TIME migration requirement
# - Not needed if you pre-created firewall rules manually (see documentation)
# - Remove after migration is complete
# - This is NOT a VPC Service Controls policy
#
################################################################################

################################################################################
# POLICY CONFIGURATION
################################################################################

# Google Cloud Service being accessed
serviceName: "compute.googleapis.com"

# Method: Insert Firewall Rules (OPTIONAL)
# Only needed if Databricks will create the firewall rule automatically
# NOT needed if you pre-created the rule as explained here:
# https://docs.databricks.com/gcp/en/admin/cloud-configurations/gcp/gce-update#updates-needed-for-customer-managed-vpcs
  methodName: "compute.v1.FirewallsService.Insert"

# Method: Get Firewall Rules (REQUIRED)
# This is a required permission for Databricks to verify firewall configuration
  methodName: "compute.v1.FirewallsService.Get"

################################################################################
# IDENTITIES AND RESOURCES
################################################################################

# Principal (Identity) performing the operation
# This should be the user or service account that will execute the migration
# Typically a Databricks administrator or service account
principalEmail: "user-updating-permission@corp.com"  # UPDATE: Your admin identity

# Source Project (WHERE requests originate FROM)
# This is the Databricks Regional Control Plane VPC project
# Find your region's project number here:
# https://docs.databricks.com/gcp/en/resources/ip-domain-region#private-service-connect-psc-attachment-uris-and-project-numbers
#
# Example project numbers by region:
# - us-east1: 51066298900
# - us-central1: 121886670913
# - us-east4: 121886670913
# - europe-west2: 216164888453
source: "projects/NNNNNNNNNNN"  # UPDATE: Databricks regional control plane VPC project

# Target Resource (WHERE rules are being created/updated)
# This is your customer-managed VPC project
# The project where your Databricks workspaces' VPC network resides
targetResource: "projects/NNNNNNNNNNN"  # UPDATE: Your customer VPC project

################################################################################
# MIGRATION CONTEXT
################################################################################
#
# WHAT IS THE GCE MIGRATION?
# Databricks is migrating classic compute from GKE-based (Kubernetes) clusters
# to GCE-based (Compute Engine) clusters for improved performance and reliability.
#
# FIREWALL RULES REQUIRED:
# The delegate-sa (delegate-sa@prod-gcp-[GEO]-[REGION].iam.gserviceaccount.com)
# needs firewall rules to launch and manage GCE-based cluster instances.
#
# REQUIRED FIREWALL RULE:
# - Name: databricks-cmv1-worker-to-worker-gce
# - Direction: INGRESS
# - Source: delegate-sa@prod-gcp-[REGION].iam.gserviceaccount.com
# - Target: All workspace subnets
# - Protocols: All (tcp, udp, icmp)
# - Purpose: Allow delegate-sa to manage cluster instances
#
################################################################################

################################################################################
# IMPLEMENTATION OPTIONS
################################################################################
#
# OPTION 1: Manual Firewall Rule Creation (RECOMMENDED)
# You can pre-create the firewall rule manually, making this policy unnecessary:
#
#   gcloud compute firewall-rules create databricks-cmv1-worker-to-worker-gce \
#     --network=VPC_NAME \
#     --direction=INGRESS \
#     --action=ALLOW \
#     --rules=all \
#     --source-service-accounts=delegate-sa@prod-gcp-[REGION].iam.gserviceaccount.com \
#     --target-tags=databricks-worker \
#     --priority=1000
#
# If you use this option, you do NOT need this policy file.
#
# OPTION 2: Allow Databricks to Create Rule (USE THIS POLICY)
# Apply this policy to allow Databricks to automatically create the required
# firewall rule during migration.
#
################################################################################

################################################################################
# HOW TO APPLY THIS POLICY
################################################################################
#
# This policy is typically applied as:
# 1. IAM Conditional Policy on your VPC project, OR
# 2. Organization Policy constraint
#
# STEP 1: Update placeholders above
# - principalEmail: Your admin identity
# - source: Databricks regional control plane project number
# - targetResource: Your customer VPC project number
#
# STEP 2: Create IAM binding or org policy
# The exact command depends on your organization's policy structure.
# Consult with your GCP administrator or Databricks support.
#
# STEP 3: Coordinate with Databricks
# Contact Databricks support to coordinate the migration timing.
#
# STEP 4: Remove policy after migration
# Once migration is complete, remove this policy as it's no longer needed.
#
################################################################################

################################################################################
# TROUBLESHOOTING
################################################################################
#
# Migration fails with permission errors:
# - Verify source project number is correct for your region
# - Verify targetResource is your customer VPC project
# - Check principalEmail has necessary IAM roles
# - Review GCP audit logs for specific permission denial
#
# Firewall rule creation fails:
# - Verify VPC network name is correct
# - Check for conflicting firewall rules with same name
# - Ensure compute.googleapis.com API is enabled
#
# delegate-sa access denied:
# - Verify delegate-sa has necessary permissions in your project
# - Check IAM bindings on subnet and network resources
# - Review VPC Service Controls perimeter (if configured)
#
################################################################################

################################################################################
# REFERENCES
################################################################################
#
# - GCE Migration Announcement: https://docs.databricks.com/gcp/en/admin/cloud-configurations/gcp/gce-update
# - Customer-Managed VPC Requirements: https://docs.databricks.com/gcp/en/admin/cloud-configurations/gcp/gce-update#updates-needed-for-customer-managed-vpcs
# - Databricks Regional Resources: https://docs.databricks.com/gcp/en/resources/ip-domain-region
# - GCP Firewall Rules: https://cloud.google.com/vpc/docs/firewalls
# - IAM Conditional Policies: https://cloud.google.com/iam/docs/conditions-overview
#
################################################################################
