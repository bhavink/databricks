################################################################################
# DATABRICKS GCP VPC SERVICE CONTROLS - WORKSPACE CREATION INGRESS POLICY
################################################################################
#
# PURPOSE:
# This policy is used DURING workspace creation to allow Databricks Control
# Plane to create necessary resources in your GCP project.
#
# USAGE STAGE: Phase 1 - Workspace Creation
# - Apply this policy BEFORE creating a Databricks workspace
# - After workspace is successfully created, replace with ingress.yaml + egress.yaml
#
# IMPORTANT NOTES:
# - The Consumer SA (db-WORKSPACEID@...) is created dynamically during workspace
#   creation, so we cannot specify it beforehand - this is why ANY_IDENTITY is used
# - This policy should be replaced after workspace creation for tighter security
#
# DOCUMENTATION REFERENCES:
# - VPC Service Controls: https://docs.gcp.databricks.com/en/security/network/vpc-sc.html
# - Regional Resources: https://docs.databricks.com/gcp/en/resources/ip-domain-region
# - Ingress/Egress Rules: https://cloud.google.com/vpc-service-controls/docs/ingress-egress-rules
#
# BEFORE USING:
# 1. Replace YOUR_SA@PROJECT.iam.gserviceaccount.com with your workspace creator identity
# 2. Replace project numbers with your actual project numbers:
#    - 68422481410 → Databricks Central project (DO NOT CHANGE)
#    - 51066298900 → Your region's Control Plane project number
#    - 1039757121236 → Your VPC/Host project number
#    - 488622148875 → Your workspace/service project number
#
################################################################################

################################################################################
# INGRESS RULE 1: Workspace Resource Setup
#
# PURPOSE: Allows Databricks Control Plane to set up workspace infrastructure
#
# TRAFFIC FLOW: Databricks Control Plane → Customer Project
#
# WHAT THIS ALLOWS:
# - Reading network, firewall, and subnet configurations
# - Setting IAM policies for workspace resources
# - Creating workspace service account and roles
# - Enabling required Google APIs
# - Creating PSC forwarding rules (for PSC workspaces)
#
# IDENTITIES:
# - Workspace creator (user or service account you specify)
# - Can be multiple identities (uncomment group/user lines as needed)
#
# SOURCE PROJECTS:
# - Databricks Central project (68422481410) - Required for all workspace creation
# - Databricks Regional Control Plane project - Specific to your region
################################################################################
- ingressFrom:
    identities:
    # Workspace Creator Identities
    # Uncomment and specify the identity creating the workspace:
    #   - group:databricks-admins@corp.com        # Google Group
    #   - user:admin@corp.com                     # Individual user
      - serviceAccount:YOUR_SA@PROJECT.iam.gserviceaccount.com  # Service Account

    sources:
    # Databricks Project Sources
    # Find your regional project number here:
    # https://docs.databricks.com/gcp/en/resources/ip-domain-region#private-service-connect-psc-attachment-uris-and-project-numbers

      # Databricks Central project - REQUIRED for all workspace creation
      # DO NOT CHANGE THIS PROJECT NUMBER
      - resource: projects/68422481410

      # Databricks Regional Control Plane project
      # REPLACE with your region's Control Plane project number
      # Example: us-east1 = 51066298900, us-central1 = 121886670913
      - resource: projects/51066298900  # UPDATE: Your region's control plane project

  ingressTo:
    operations:
      ############################################################################
      # Compute Engine API Operations
      # Required for: Network configuration, firewall setup, PSC endpoints
      ############################################################################
      - methodSelectors:
          # Network configuration - Read VPC network settings
          - method: 'NetworksService.Get'

          # Project information - Verify project access and configuration
          - method: 'ProjectsService.Get'

          # Firewall rules - Read and create required firewall rules
          - method: 'FirewallsService.Get'
          - method: 'FirewallsService.Insert'  # Create workspace firewall rules

          # Subnet configuration - Read and configure subnet permissions
          - method: 'SubnetworksService.Get'
          - method: 'SubnetworksService.SetPolicy'  # Set IAM policy on subnet
          - method: 'SubnetworksService.GetPolicy'  # Read subnet IAM policy

          # Operation tracking - Monitor async operations progress
          - method: 'GlobalOperationsService.Get'

          # PSC-specific - Create Private Service Connect forwarding rules
          # Only used for PSC-enabled workspaces
          - method: 'RegionForwardingRulesService.Get'
        serviceName: compute.googleapis.com

      ############################################################################
      # Service Usage API Operations
      # Required for: Enabling required Google APIs in customer project
      ############################################################################
      - methodSelectors:
          # Allow all methods because VPC-SC doesn't support fine-grained filtering
          # The only call needed: google.api.serviceusage.v1.ServiceUsage.ListServices
          # This verifies required APIs (compute, storage, etc.) are enabled
          - method: '*'
        serviceName: serviceusage.googleapis.com

      ############################################################################
      # Cloud Resource Manager API Operations
      # Required for: Setting project-level IAM policies
      ############################################################################
      - methodSelectors:
          # Set IAM policy - Grant workspace SA permissions on project
          - method: 'Projects.SetIamPolicy'
        serviceName: cloudresourcemanager.googleapis.com

      ############################################################################
      # IAM API Operations
      # Required for: Creating workspace service account and custom roles
      ############################################################################
      - methodSelectors:
          # Role management - Read and create custom roles
          - method: 'IAM.GetRole'
          - method: 'IAM.CreateRole'

          # IAM policy management - Read and set IAM policies
          - method: 'IAM.GetIamPolicy'
          - method: 'IAM.SetIamPolicy'

          # Service account - Read service account details
          - method: 'IAM.GetServiceAccount'
        serviceName: iam.googleapis.com

    resources:
      # Target projects where these operations are allowed
      - projects/1039757121236  # UPDATE: Your VPC/Host project number
      - projects/488622148875   # UPDATE: Your workspace/service project number

################################################################################
# INGRESS RULE 2: DBFS Storage Creation
#
# PURPOSE: Allows Databricks to create DBFS storage buckets
#
# WHY ANY_IDENTITY?
# The workspace-specific service account (Consumer SA) is created DURING workspace
# creation by Databricks. The format is:
#   db-[WORKSPACEID]@prod-gcp-[REGION].iam.gserviceaccount.com
#
# Since the workspace ID is generated dynamically and unknown beforehand, we
# cannot specify the exact service account identity in this policy. Therefore,
# we use ANY_IDENTITY with source project restrictions to limit access.
#
# SECURITY CONSIDERATIONS:
# - Requests must still originate from Databricks Central project (68422481410)
# - Requests must match Access Level (Control Plane NAT IPs)
# - Only storage bucket creation and KMS operations are allowed
# - After workspace creation, remove this rule or replace with specific Consumer SA
#
# WHAT THIS CREATES:
# - projects/[PROJECT]/buckets/databricks-[WORKSPACEID] (main DBFS bucket)
# - projects/[PROJECT]/buckets/databricks-[WORKSPACEID]-system (system bucket)
#
# POST-CREATION:
# After workspace is created, you can replace this rule with a specific identity
# rule in ingress.yaml that explicitly lists the Consumer SA
################################################################################
- ingressFrom:
    # Use ANY_IDENTITY because Consumer SA doesn't exist yet
    # This identity is created dynamically at workspace creation time
    identityType: ANY_IDENTITY

    sources:
      # Databricks Central project - Creates DBFS buckets on behalf of workspace
      # DO NOT CHANGE THIS PROJECT NUMBER
      - resource: projects/68422481410

  ingressTo:
    operations:
      ############################################################################
      # Cloud Storage API Operations
      # Required for: Creating DBFS storage buckets
      ############################################################################
      - methodSelectors:
          # Create DBFS buckets - Required during workspace creation
          # RECOMMENDATION: Remove this permission after workspace creation
          # and replace with specific Consumer SA in ingress.yaml
          - method: 'google.storage.buckets.create'
        serviceName: storage.googleapis.com

      ############################################################################
      # Cloud KMS API Operations (Optional)
      # Required for: Customer-Managed Encryption Keys (CMEK)
      # Only needed if you're using CMEK for DBFS encryption
      ############################################################################
      - methodSelectors:
          # Allow all methods because VPC-SC doesn't support method filtering for KMS
          # Required operations: encrypt, decrypt, getKeyRing, getCryptoKey
          # RECOMMENDATION: Remove if not using CMEK, or remove after workspace creation
          - method: '*'
        serviceName: cloudkms.googleapis.com

    resources:
      # Target project where DBFS buckets will be created
      - projects/488622148875  # UPDATE: Your workspace/service project number

################################################################################
# NEXT STEPS AFTER WORKSPACE CREATION:
#
# 1. Verify workspace created successfully:
#    - Check Databricks UI to confirm workspace is accessible
#    - Verify DBFS buckets exist: databricks-[WORKSPACEID] and databricks-[WORKSPACEID]-system
#    - Confirm Consumer SA exists: db-[WORKSPACEID]@prod-gcp-[REGION].iam.gserviceaccount.com
#
# 2. Update VPC-SC perimeter:
#    - Replace this policy with ingress.yaml (operational ingress rules)
#    - Add egress.yaml (cluster egress rules)
#    - Test in dry-run mode first
#    - Enforce updated perimeter
#
# 3. Test cluster creation:
#    - Launch a test cluster to verify egress policies work
#    - Confirm cluster can access DBFS and runtime images
#    - Monitor VPC-SC logs for any violations
#
# TROUBLESHOOTING:
# - If workspace creation fails with VPC-SC violation:
#   • Check Access Level includes correct Control Plane IPs
#   • Verify project numbers are correct for your region
#   • Review VPC-SC audit logs: gcloud logging read "protoPayload.metadata.@type=type.googleapis.com/google.cloud.audit.VpcServiceControlAuditMetadata"
#
# - If DBFS bucket creation fails:
#   • Ensure ANY_IDENTITY rule is present
#   • Verify Databricks Central project (68422481410) is in sources
#   • Check that storage.googleapis.com is in restricted services
################################################################################
