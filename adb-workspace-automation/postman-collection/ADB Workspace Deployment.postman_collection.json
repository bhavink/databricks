{
  "info": {
    "_postman_id": "cba1c311-09fd-4b0a-b6ce-15bccf3ac052",
    "name": "ADB Workspace Deployment",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "1-get management token to provision workspace",
      "event": [
        {
          "listen": "test",
          "script": {
            "id": "a9b08347-ae01-405b-a661-d11d46aca125",
            "exec": [
              "pm.test(pm.info.requestName, () => {",
              "    pm.response.to.not.be.error;",
              "    pm.response.to.not.have.jsonBody('error');",
              "});",
              "pm.globals.set(\"management_token\", pm.response.json().access_token);"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/x-www-form-urlencoded"
          }
        ],
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            {
              "key": "grant_type",
              "value": "client_credentials",
              "type": "text"
            },
            {
              "key": "client_id",
              "value": "{{client_id}}",
              "type": "text"
            },
            {
              "key": "client_secret",
              "value": "{{client_secret}}",
              "type": "text"
            },
            {
              "key": "resource",
              "value": "{{management_resource_endpoint}}",
              "type": "text"
            }
          ]
        },
        "url": {
          "raw": "https://login.microsoftonline.com/{{tenant_id}}/oauth2/token",
          "protocol": "https",
          "host": ["login", "microsoftonline", "com"],
          "path": ["{{tenant_id}}", "oauth2", "token"]
        }
      },
      "response": []
    },
    {
      "name": "2-deploy databricks via arm template",
      "request": {
        "auth": {
          "type": "bearer",
          "bearer": [
            {
              "key": "token",
              "value": "{{management_token}}",
              "type": "string"
            }
          ]
        },
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "type": "text",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"properties\": {\n    \"mode\": \"Incremental\",\n    \"template\": {\n      \"$schema\": \"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#\",\n      \"contentVersion\": \"1.0.0.0\",\n      \"parameters\": {\n        \"nsgName\": {\n          \"defaultValue\": \"databricks-{{databricks_workspace_name}}-nsg\",\n          \"type\": \"string\",\n          \"metadata\": {\n            \"description\": \"The name of the network security group to create.\"\n          }\n        },\n        \"vnetName\": {\n          \"defaultValue\": \"databricks-vnet\",\n          \"type\": \"string\",\n          \"metadata\": {\n            \"description\": \"The name of the virtual network to create.\"\n          }\n        },\n        \"workspaceName\": {\n          \"defaultValue\": \"test-vnet-name\",\n          \"type\": \"string\",\n          \"metadata\": {\n            \"description\": \"The name of the Azure Databricks workspace to create.\"\n          }\n        },\n        \"privateSubnetName\": {\n          \"defaultValue\": \"container-subnet\",\n          \"type\": \"string\",\n          \"metadata\": {\n            \"description\": \"The name of the private subnet to create.\"\n          }\n        },\n        \"publicSubnetName\": {\n          \"defaultValue\": \"host-subnet\",\n          \"type\": \"string\",\n          \"metadata\": {\n            \"description\": \"The name of the public subnet to create.\"\n          }\n        },\n        \"pricingTier\": {\n          \"defaultValue\": \"premium\",\n          \"allowedValues\": [\"trial\", \"standard\", \"premium\"],\n          \"type\": \"string\",\n          \"metadata\": {\n            \"description\": \"The pricing tier of workspace.\"\n          }\n        },\n        \"location\": {\n          \"type\": \"string\",\n          \"defaultValue\": \"[resourceGroup().location]\",\n          \"metadata\": {\n            \"description\": \"Location for all resources.\"\n          }\n        },\n        \"vnetCidr\": {\n          \"defaultValue\": \"11.141.13.0/22\",\n          \"type\": \"string\",\n          \"metadata\": {\n            \"description\": \"Cidr range for the vnet.\"\n          }\n        },\n        \"publicSubnetCidr\": {\n          \"defaultValue\": \"11.141.13.64/26\",\n          \"type\": \"string\",\n          \"metadata\": {\n            \"description\": \"Cidr range for the public subnet..\"\n          }\n        },\n        \"privateSubnetCidr\": {\n          \"defaultValue\": \"11.141.13.128/26\",\n          \"type\": \"string\",\n          \"metadata\": {\n            \"description\": \"Cidr range for the private subnet.\"\n          }\n        }\n      },\n      \"variables\": {\n        \"nsgId\": \"[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]\",\n        \"vnetId\": \"[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]\",\n        \"managedResourceGroupId\": \"[concat(subscription().id, '/resourceGroups/', variables('managedResourceGroupName'))]\",\n        \"managedResourceGroupName\": \"[concat('databricks-rg-', parameters('workspaceName'), '-', uniqueString(parameters('workspaceName'), resourceGroup().id))]\"\n      },\n      \"resources\": [\n        {\n          \"apiVersion\": \"2019-06-01\",\n          \"type\": \"Microsoft.Network/networkSecurityGroups\",\n          \"location\": \"[parameters('location')]\",\n          \"name\": \"[parameters('nsgName')]\"\n        },\n        {\n          \"apiVersion\": \"2019-06-01\",\n          \"type\": \"Microsoft.Network/virtualNetworks\",\n          \"location\": \"[parameters('location')]\",\n          \"name\": \"[parameters('vnetName')]\",\n          \"dependsOn\": [\n            \"[concat('Microsoft.Network/networkSecurityGroups/', parameters('nsgName'))]\"\n          ],\n          \"properties\": {\n            \"addressSpace\": {\n              \"addressPrefixes\": [\"[parameters('vnetCidr')]\"]\n            },\n            \"subnets\": [\n              {\n                \"name\": \"[parameters('publicSubnetName')]\",\n                \"properties\": {\n                  \"addressPrefix\": \"[parameters('publicSubnetCidr')]\",\n                  \"networkSecurityGroup\": {\n                    \"id\": \"[variables('nsgId')]\"\n                  },\n                  \"delegations\": [\n                    {\n                      \"name\": \"databricks-del-public\",\n                      \"properties\": {\n                        \"serviceName\": \"Microsoft.Databricks/workspaces\"\n                      }\n                    }\n                  ]\n                }\n              },\n              {\n                \"name\": \"[parameters('privateSubnetName')]\",\n                \"properties\": {\n                  \"addressPrefix\": \"[parameters('privateSubnetCidr')]\",\n                  \"networkSecurityGroup\": {\n                    \"id\": \"[variables('nsgId')]\"\n                  },\n                  \"delegations\": [\n                    {\n                      \"name\": \"databricks-del-private\",\n                      \"properties\": {\n                        \"serviceName\": \"Microsoft.Databricks/workspaces\"\n                      }\n                    }\n                  ]\n                }\n              }\n            ]\n          }\n        },\n        {\n          \"apiVersion\": \"2018-04-01\",\n          \"type\": \"Microsoft.Databricks/workspaces\",\n          \"location\": \"[parameters('location')]\",\n          \"name\": \"[parameters('workspaceName')]\",\n          \"dependsOn\": [\n            \"[concat('Microsoft.Network/networkSecurityGroups/', parameters('nsgName'))]\",\n            \"[concat('Microsoft.Network/virtualNetworks/', parameters('vnetName'))]\"\n          ],\n          \"sku\": {\n            \"name\": \"[parameters('pricingTier')]\"\n          },\n          \"comments\": \"The managed resource group specified will be locked after deployment.\",\n          \"properties\": {\n            \"ManagedResourceGroupId\": \"[variables('managedResourceGroupId')]\",\n            \"parameters\": {\n              \"customVirtualNetworkId\": {\n                \"value\": \"[variables('vnetId')]\"\n              },\n              \"customPublicSubnetName\": {\n                \"value\": \"[parameters('publicSubnetName')]\"\n              },\n              \"customPrivateSubnetName\": {\n                \"value\": \"[parameters('privateSubnetName')]\"\n              }\n            }\n          }\n        }\n      ]\n    },\n    \"parameters\": {\n      \"workspaceName\": {\n        \"value\": \"{{databricks_workspace_name}}\"\n      },\n      \"pricingTier\": {\n        \"value\": \"{{databricks_pricing_tier}}\"\n      },\n      \"nsgName\": {\n        \"value\": \"{{databricks_nsg_name}}\"\n      },\n      \"vnetName\": {\n        \"value\": \"{{databricks_vnet_name}}\"\n      },\n      \"vnetCidr\": {\n        \"value\": \"{{databricks_vnet_cidr}}\"\n      },\n      \"privateSubnetName\": {\n        \"value\": \"{{databricks_container_subnet_name}}\"\n      },\n      \"publicSubnetName\": {\n        \"value\": \"{{databricks_host_subnet_name}}\"\n      },\n      \"privateSubnetCidr\": {\n        \"value\": \"{{databricks_container_subnet_cidr}}\"\n      },\n      \"publicSubnetCidr\": {\n        \"value\": \"{{databricks_host_subnet_cidr}}\"\n      }\n    }\n  }\n}\n"
        },
        "url": {
          "raw": "https://management.azure.com/subscriptions/{{subscription_id}}/resourcegroups/{{resource_group}}/providers/Microsoft.Resources/deployments/{{resource_deployment_name}}?api-version=2019-05-01",
          "protocol": "https",
          "host": ["management", "azure", "com"],
          "path": [
            "subscriptions",
            "{{subscription_id}}",
            "resourcegroups",
            "{{resource_group}}",
            "providers",
            "Microsoft.Resources",
            "deployments",
            "{{resource_deployment_name}}"
          ],
          "query": [
            {
              "key": "api-version",
              "value": "2019-05-01"
            }
          ]
        }
      },
      "response": []
    },
    {
      "name": "3-check deployment status",
      "request": {
        "auth": {
          "type": "bearer",
          "bearer": [
            {
              "key": "token",
              "value": "{{management_token}}",
              "type": "string"
            }
          ]
        },
        "method": "GET",
        "header": [],
        "url": {
          "raw": "https://management.azure.com/subscriptions/{{subscription_id}}/resourcegroups/{{resource_group}}/providers/Microsoft.Resources/deployments/{{resource_deployment_name}}?api-version=2018-05-01",
          "protocol": "https",
          "host": ["management", "azure", "com"],
          "path": [
            "subscriptions",
            "{{subscription_id}}",
            "resourcegroups",
            "{{resource_group}}",
            "providers",
            "Microsoft.Resources",
            "deployments",
            "{{resource_deployment_name}}"
          ],
          "query": [
            {
              "key": "api-version",
              "value": "2018-05-01"
            }
          ]
        }
      },
      "response": []
    },
    {
      "name": "4-get an aad access token for databricks resource",
      "event": [
        {
          "listen": "test",
          "script": {
            "id": "a9b08347-ae01-405b-a661-d11d46aca125",
            "exec": [
              "pm.test(pm.info.requestName, () => {",
              "    pm.response.to.not.be.error;",
              "    pm.response.to.not.have.jsonBody('error');",
              "});",
              "pm.globals.set(\"access_token\", pm.response.json().access_token);"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "auth": {
          "type": "noauth"
        },
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "name": "Content-Type",
            "value": "text/plain",
            "type": "text"
          }
        ],
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            {
              "key": "grant_type",
              "value": "client_credentials",
              "type": "text"
            },
            {
              "key": "client_id",
              "value": "{{client_id}}",
              "type": "text"
            },
            {
              "key": "client_secret",
              "value": "{{client_secret}}",
              "type": "text"
            },
            {
              "key": "resource",
              "value": "{{databricks_resource_id}}",
              "type": "text"
            }
          ],
          "options": {
            "raw": {
              "language": "text"
            }
          }
        },
        "url": {
          "raw": "https://login.microsoftonline.com/{{tenant_id}}/oauth2/token",
          "protocol": "https",
          "host": ["login", "microsoftonline", "com"],
          "path": ["{{tenant_id}}", "oauth2", "token"]
        }
      },
      "response": []
    },
    {
      "name": "5-get management resource token",
      "event": [
        {
          "listen": "test",
          "script": {
            "id": "a9b08347-ae01-405b-a661-d11d46aca125",
            "exec": [
              "pm.test(pm.info.requestName, () => {",
              "    pm.response.to.not.be.error;",
              "    pm.response.to.not.have.jsonBody('error');",
              "});",
              "pm.globals.set(\"management_token\", pm.response.json().access_token);"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "auth": {
          "type": "noauth"
        },
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "name": "Content-Type",
            "value": "text/plain",
            "type": "text"
          }
        ],
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            {
              "key": "grant_type",
              "value": "client_credentials",
              "type": "text"
            },
            {
              "key": "client_id",
              "value": "{{client_id}}",
              "type": "text"
            },
            {
              "key": "client_secret",
              "value": "{{client_secret}}",
              "type": "text"
            },
            {
              "key": "resource",
              "value": "{{management_resource_endpoint}}",
              "description": "get management access token",
              "type": "text"
            }
          ],
          "options": {
            "raw": {
              "language": "text"
            }
          }
        },
        "url": {
          "raw": "https://login.microsoftonline.com/{{tenant_id}}/oauth2/token",
          "protocol": "https",
          "host": ["login", "microsoftonline", "com"],
          "path": ["{{tenant_id}}", "oauth2", "token"]
        }
      },
      "response": []
    },
    {
      "name": "6-initialize workspace",
      "request": {
        "auth": {
          "type": "bearer",
          "bearer": [
            {
              "key": "token",
              "value": "{{access_token}}",
              "type": "string"
            }
          ]
        },
        "method": "GET",
        "header": [
          {
            "key": "X-Databricks-Azure-Workspace-Resource-Id",
            "value": "/subscriptions/{{subscription_id}}/resourceGroups/{{resource_group}}/providers/Microsoft.Databricks/workspaces/{{databricks_workspace_name}}",
            "type": "text"
          },
          {
            "key": "X-Databricks-Azure-SP-Management-Token",
            "value": "{{management_token}}",
            "type": "text"
          },
          {
            "key": "Content-Type",
            "value": "application/x-www-form-urlencoded",
            "type": "text"
          }
        ],
        "url": {
          "raw": "https://{{azure_region}}.azuredatabricks.net/api/2.0/preview/scim/v2/ServicePrincipals",
          "protocol": "https",
          "host": ["{{azure_region}}", "azuredatabricks", "net"],
          "path": ["api", "2.0", "preview", "scim", "v2", "ServicePrincipals"]
        }
      },
      "response": []
    },
    {
      "name": "7-list node types",
      "event": [
        {
          "listen": "test",
          "script": {
            "id": "a9b08347-ae01-405b-a661-d11d46aca125",
            "exec": [
              "pm.test(pm.info.requestName, () => {",
              "    pm.response.to.not.be.error;",
              "    pm.response.to.not.have.jsonBody('error');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "protocolProfileBehavior": {
        "disableBodyPruning": true
      },
      "request": {
        "auth": {
          "type": "bearer",
          "bearer": [
            {
              "key": "token",
              "value": "{{access_token}}",
              "type": "string"
            }
          ]
        },
        "method": "GET",
        "header": [
          {
            "key": "Content-Type",
            "name": "Content-Type",
            "value": "text/plain",
            "type": "text"
          },
          {
            "key": "X-Databricks-Azure-Workspace-Resource-Id",
            "value": "/subscriptions/{{subscription_id}}/resourceGroups/{{resource_group}}/providers/Microsoft.Databricks/workspaces/{{databricks_workspace_name}}",
            "type": "text"
          },
          {
            "key": "X-Databricks-Azure-SP-Management-Token",
            "value": "{{management_token}}",
            "type": "text"
          }
        ],
        "body": {
          "mode": "urlencoded",
          "urlencoded": [],
          "options": {
            "raw": {
              "language": "text"
            }
          }
        },
        "url": {
          "raw": "https://{{azure_region}}.azuredatabricks.net/api/2.0/clusters/list-node-types",
          "protocol": "https",
          "host": ["{{azure_region}}", "azuredatabricks", "net"],
          "path": ["api", "2.0", "clusters", "list-node-types"]
        }
      },
      "response": []
    },
    {
      "name": "8-generate databricks platform access token (PAT)",
      "event": [
        {
          "listen": "test",
          "script": {
            "id": "a9b08347-ae01-405b-a661-d11d46aca125",
            "exec": [
              "pm.test(pm.info.requestName, () => {",
              "    pm.response.to.not.be.error;",
              "    pm.response.to.not.have.jsonBody('error');",
              "});",
              "pm.globals.set(\"databricks_platform_token\", pm.response.json().token_value);"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "auth": {
          "type": "bearer",
          "bearer": [
            {
              "key": "token",
              "value": "{{access_token}}",
              "type": "string"
            }
          ]
        },
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/x-www-form-urlencoded"
          },
          {
            "key": "X-Databricks-Azure-Workspace-Resource-Id",
            "type": "text",
            "value": "/subscriptions/{{subscription_id}}/resourceGroups/{{resource_group}}/providers/Microsoft.Databricks/workspaces/{{databricks_workspace_name}}"
          },
          {
            "key": "X-Databricks-Azure-SP-Management-Token",
            "type": "text",
            "value": "{{management_token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"lifetime_seconds\":10000,\n  \"comment\": \"this is an example token generated for service principal with no expiry\"\n}"
        },
        "url": {
          "raw": "https://{{azure_region}}.azuredatabricks.net/api/2.0/token/create",
          "protocol": "https",
          "host": ["{{azure_region}}", "azuredatabricks", "net"],
          "path": ["api", "2.0", "token", "create"]
        }
      },
      "response": []
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "id": "3eba84a3-ac67-424a-aa26-62e56cadb4ac",
        "type": "text/javascript",
        "exec": [""]
      }
    },
    {
      "listen": "test",
      "script": {
        "id": "7f2caf8d-f4cd-4476-8f0d-5b0ddd4864d6",
        "type": "text/javascript",
        "exec": [""]
      }
    }
  ],
  "variable": [
    {
      "id": "36111376-832b-4147-bf28-e9545f4d6cd6",
      "key": "tenant_id",
      "value": "",
      "type": "string"
    },
    {
      "id": "7d803c4f-267f-488e-931a-ba2fb8b6c179",
      "key": "client_id",
      "value": "",
      "type": "string"
    },
    {
      "id": "eee3a3b1-17e6-461f-8f66-334c607c69a4",
      "key": "client_secret",
      "value": "",
      "type": "string"
    },
    {
      "id": "6e517b3d-4811-4a93-8bad-41dcf39a5c32",
      "key": "databricks_resource_id",
      "value": "",
      "type": "string"
    },
    {
      "id": "2a24288f-b3b3-44b4-8fbf-9b36e06c7aaa",
      "key": "subscription_id",
      "value": "",
      "type": "string"
    },
    {
      "id": "a9dfcefe-0617-4d83-b344-8d1ab9ebc726",
      "key": "management_resource_endpoint",
      "value": "",
      "type": "string"
    },
    {
      "id": "c29eaa14-f957-4347-91ee-d626b692a424",
      "key": "resource_group",
      "value": "",
      "type": "string"
    },
    {
      "id": "209f822f-1139-4846-aa28-9234a9aa855d",
      "key": "azure_region",
      "value": "",
      "type": "string"
    },
    {
      "id": "c60679a4-f389-4252-8a40-7bcd43910c09",
      "key": "resource_deployment_name",
      "value": "",
      "type": "string"
    },
    {
      "id": "ddc41ee2-21f1-4835-8638-4dbce4e9ba12",
      "key": "databricks_workspace_name",
      "value": "",
      "type": "string"
    },
    {
      "id": "f4b72115-2c2b-4277-865e-6ace7a5b42b5",
      "key": "databricks_vnet_cidr",
      "value": "",
      "type": "string"
    },
    {
      "id": "d6cb9b86-d724-4ffe-945c-26184c0f0fe7",
      "key": "databricks_vnet_name",
      "value": "",
      "type": "string"
    },
    {
      "id": "be0e8455-05fe-4bcc-a3fb-29b584876b6e",
      "key": "databricks_host_subnet_name",
      "value": "",
      "type": "string"
    },
    {
      "id": "e6575edb-0001-4974-a5fa-1eb2d5af3ce0",
      "key": "databricks_host_subnet_cidr",
      "value": "",
      "type": "string"
    },
    {
      "id": "1fa0c337-19fb-4037-9be8-a14176928b91",
      "key": "databricks_container_subnet_name",
      "value": "",
      "type": "string"
    },
    {
      "id": "9f07b459-102e-43e3-953c-76e650f0ef86",
      "key": "databricks_container_subnet_cidr",
      "value": "",
      "type": "string"
    },
    {
      "id": "7579a6fa-41e3-47d7-870c-34e3f3b2b3d6",
      "key": "databricks_nsg_name",
      "value": "",
      "type": "string"
    },
    {
      "id": "b0d68107-250d-439a-935d-b27d99d44a3b",
      "key": "databricks_pricing_tier",
      "value": "",
      "type": "string"
    }
  ],
  "protocolProfileBehavior": {}
}
